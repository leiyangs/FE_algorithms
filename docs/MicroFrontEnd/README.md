# 如何落地微前端

## 为什么使用微前端

- 维护同一个前端应用，如何避免需求撞车？
- 老旧的项目如何重构？
- 应用的整合可以让不同前端技术栈的应用融合，并提供类SPA的应用体验。将业务模块化，有更好的业务复用能力，与需求响应速度。
- 应用的拆分可以让应用在构建时解耦，团队协作更高效。构建时解耦同时也提供了渐进式重构的能力。

## 为什么不用iframe？

- url不同步，浏览器刷新iframe url状态丢失，后退前进按钮无法使用

- UI不同步，DOM结构不共享。想象一下屏幕右下角1/4的iframe里来一个带遮罩的弹框，同时我们要求这个弹框要浏览器居中显示，还要浏览器resize时自动居中。

- 全局上下文完全隔离，内存变量不共享。iframe内部系统的通信、数据同步等需求，主应用的cookie要透传到根域名到不同的子应用中实现免登录效果。

- 性能差，每次子应用进入都是一次浏览器上下文重建，资源重新加载的过程。

## 微前端落地的准备

需要持续的投入前端资源，后期还需要投入测试资源，帮助我们回归测试，对公司来说也是很大的资源投入。

## 应用的整合与拆分

### 划分思路

- [康威定律](https://blog.csdn.net/chen978616649/article/details/113369217)：根据团队的组织结构合理的划分

- 领域拆分：根据公共行为抽象合理的划分

随着业务组织的发展，业务团队适合组织结构的划分方式，中台团队适合领域划分的方式。

### 实施方式

- 基于URL的划分

- 基于功能服务的划分

### 拆分粒度

- 太细：应用间强依赖，频繁通信，违背了微应用的设计原则。
- 太粗：巨石应用的问题。

#### 原则

应用在独立打开的情况下， 能完成一个独立功能的提交。
应用合理划分完成，业务开发同学只需要负责自己业务的前端应用。但是应用的数量增加，需要对应用进行有效的管理。

## 实现核心

### 应用加载器

1. 独立开发部署
2. 编译时解耦
3. 技术栈无关
4. 应用的调度

根据注册的子应用，通过给定的激活规则，加载约定格式的子应用入口，并挂载到给定位置。
大部分会提供默认路由激活能力，通过路由劫持实现。

### 运行时沙盒js

#### 快照

### 运行时沙盒css

#### 快照

跟随应用切换stylesheet。多个应用之间不能共存，并可能冲突。

#### scope css

每个应用样式增加一个hash前缀。应用间使用相同的三方依赖样式可能冲突。

#### Shadow DOM

Shadow DOM原生支持样式隔离。子应用的全局弹窗样式会丢失，兼容性较差。

#### 没有银弹

市面上暂时没有完美的解决方案，建议使用用工程化的方式加前缀来防止冲突，比如 BEM / css modules / css in js / 自定义前缀等。
